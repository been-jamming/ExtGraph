#define NO_EXIT_SUPPORT
#define MIN_AMS 100
#define NO_AMS_CHECK

#ifdef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define C89_92V200(x,y) (x)
#else
#undef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define USE_TI92P
#define USE_V200
#define C89_92V200(x,y) (y)
#endif

#include <tigcclib.h>
#include "../../lib/ExtGraph.h"
#include "../../lib/TileMap.h"

char fg_map[16][25]={ // Premier plan
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8,19,19,19, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,19,19, 8, 8, 8},
{ 8, 8,16,17,17,17,17,17,18, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,16,17,17,17,18, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8,16,18, 8, 8, 8, 8, 8, 8, 8, 8,16,17,18, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8,19,19, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8,16,17,17,17,17,17,18, 8, 8, 8, 8, 8, 8, 8, 8, 8,16,17,18, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,16,17,17,18, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8,19, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8,16,17,17,17,18, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,19,19, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,16,17,17,17,18, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8},
{ 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8}
};
char bg_map[12][20]={ // Arrière-plan
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 6,11, 0, 0, 0},
{ 0, 0, 0, 1, 6, 6,11, 0, 0, 0, 0, 0, 1, 3, 8, 8,12,11, 0, 0},
{ 0, 0, 1, 3, 7,10,12,11, 0, 0, 0, 1, 3, 8, 7,10, 8,12,11, 0},
{ 0, 0, 2, 4, 8, 8,13,15, 0, 0, 0, 2, 4, 8, 8, 8, 8,13,14, 0},
{ 0, 0, 0, 5, 9, 9,14, 0, 0, 0, 0, 0, 5, 4, 8, 8,13,15, 0, 0},
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 9, 9,14, 0, 0, 0},
{ 0, 0, 0, 1, 6,11, 0, 0, 1, 6, 6,11, 0, 0, 0, 0, 0, 0, 0, 0},
{ 0, 0, 0, 5, 9,14, 0, 1, 3, 8, 8,12,11, 0, 0, 0, 0, 0, 0, 0},
{ 6, 6,11, 0, 0, 0, 0, 5, 4, 8, 8,13,14, 0, 0, 0, 1, 6, 6,11},
{ 7,10,12,11, 0, 0, 0, 0, 2, 9, 9,15, 0, 0, 0, 0, 2, 9, 9,14},
{ 8, 8,13,14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}
};

short sprts[][32]={
// 0 : Nuage 1
{0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF},
// 1 : Nuage 2
{0x0007,0xFFF8,0x003F,0xFFC0,0x00F8,0xFF00,0x01C0,0xFE00,0x0300,0xFC00,0x0600,0xF800,0x0C00,0xF000,0x1800,0xE000,0x3000,0xC000,0x3000,0xC000,0x6000,0x8000,0x6000,0x8000,0x6000,0x8000,0xC000,0x0000,0xC000,0x0000,0xC000,0x0000},
// 2 : Nuage 3
{0xC000,0x0000,0xC000,0x0000,0xC000,0x0000,0x6000,0x8000,0x6000,0x8000,0x3800,0xC000,0x1F80,0xE000,0x07C0,0xF800,0x00C0,0xFF00,0x00C0,0xFF00,0x00C0,0xFF00,0x0060,0xFF80,0x0060,0xFF80,0x0038,0xFFC0,0x001F,0xFFE0,0x0007,0xFFF8},
// 3 : Nuage 4
{0xC000,0x0000,0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 4 : Nuage 5
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8000,0x0000,0xC000,0x0000},
// 5 : Nuage 6
{0xC000,0x0000,0xC000,0x0000,0xC000,0x0000,0x6000,0x8000,0x6000,0x8000,0x6000,0x8000,0x3000,0xC000,0x3000,0xC000,0x1800,0xE000,0x0C00,0xF000,0x0600,0xF800,0x0300,0xFC00,0x01C0,0xFE00,0x00F8,0xFF00,0x003F,0xFFC0,0x0007,0xFFF8},
// 6 : Nuage 7
{0xE007,0x1FF8,0xFC3F,0x03C0,0x1FF8,0x0000,0x03C0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 7 : Nuage 8
{0x0000,0x0000,0x0008,0x0000,0x001C,0x0000,0x001C,0x0000,0x001C,0x0000,0x001C,0x0000,0x001C,0x0000,0x0008,0x0000,0x0000,0x0000,0x0000,0x0000,0x0060,0x0000,0x00E0,0x0000,0x00F8,0x0000,0x007F,0x0000,0x001F,0x0000,0x0007,0x0000},
// 8 : Nuage 9 (tout blanc)
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 9 : Nuage 10
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x03C0,0x0000,0x1FF8,0x0000,0xFC3F,0x03C0,0xE007,0x1FF8},
// 10 : Nuage 11
{0x0000,0x0000,0x0800,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x0800,0x0000,0x0000,0x0000,0x0000,0x0000,0x0600,0x0000,0x0700,0x0000,0x1F00,0x0000,0xFE00,0x0000,0xF800,0x0000,0xE000,0x0000},
// 11 : Nuage 12
{0xE000,0x1FFF,0xFC00,0x03FF,0x1F00,0x00FF,0x0380,0x007F,0x00C0,0x003F,0x0060,0x001F,0x0030,0x000F,0x0018,0x0007,0x000C,0x0003,0x000C,0x0003,0x0006,0x0001,0x0006,0x0001,0x0006,0x0001,0x0003,0x0000,0x0003,0x0000,0x0003,0x0000},
// 12 : Nuage 13
{0x0003,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 13 : Nuage 14
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0003,0x0000},
// 14 : Nuage 15
{0x0003,0x0000,0x0003,0x0000,0x0003,0x0000,0x0006,0x0001,0x0006,0x0001,0x001C,0x0003,0x01F8,0x0007,0x03E0,0x001F,0x0300,0x00FF,0x0300,0x00FF,0x0300,0x00FF,0x0600,0x01FF,0x0600,0x01FF,0x1C00,0x03FF,0xF800,0x07FF,0xE000,0x1FFF},
// 15 : Nuage 16
{0x0003,0x0000,0x0003,0x0000,0x0003,0x0000,0x0006,0x0001,0x0006,0x0001,0x0006,0x0001,0x000C,0x0003,0x000C,0x0003,0x0018,0x0007,0x0030,0x000F,0x0060,0x001F,0x00C0,0x003F,0x0380,0x007F,0x1F00,0x00FF,0xFC00,0x03FF,0xE000,0x1FFF},

// 16 : Plate-Forme 1
{0x3FFF,0x3FFF,0x7FFF,0x6000,0x7FFF,0x4000,0xFFFF,0xC000,0xFFFF,0x8000,0xFFEF,0x8010,0xFB7B,0x8484,0xEEAD,0x9152,0xFBDF,0x8420,0xF6F6,0x8909,0xFF7C,0x8083,0xFE5C,0x81A3,0xD038,0xAFC7,0xA800,0xD7FF,0x43C3,0x7FFF,0x3C3C,0x3C3C},
// 17 : Plate-Forme 2
{0xFFFF,0xFFFF,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xEFEF,0x1010,0x7B7B,0x8484,0xADAD,0x5252,0xBDFD,0x4202,0xD7D7,0x2828,0xFFFE,0x0001,0x5F5E,0xA0A1,0x7828,0x87D7,0x0000,0xFFFF,0xC3C3,0xFFFF,0x3C3C,0x3C3C},
// 18 : Plate-Forme 3
{0xFFF8,0xFFF8,0xFFE4,0x001C,0xFFF2,0x000E,0xFFF2,0x000E,0xFFF1,0x000F,0xEFF1,0x100F,0x7BD1,0x842F,0xAD71,0x528F,0xDFE1,0x201F,0xF671,0x098F,0x7C21,0x83DF,0x5C61,0xA39F,0x3851,0xC7AF,0x00A1,0xFFDF,0xC342,0xFF7E,0x3C3C,0x3C3C},

// 19 : Barrière
{0x03C0,0x03C0,0x0660,0x05E0,0xFE3F,0xF9FF,0xEE77,0x19F8,0xFE7F,0xF9FF,0xFF7F,0xF8FF,0x0F70,0x08F0,0x0F30,0x08F0,0x0F30,0x08F0,0x0E30,0x09F0,0xFE3F,0xF9FF,0xEE73,0x19FC,0xFE7F,0xF9FF,0xFF7F,0xF8FF,0x0F70,0x08F0,0x0FF0,0x0FF0},
};

#define HEIGHT C89_92V200(100,128)
#define WIDTH  C89_92V200(160,240)

static inline void RenderMaps(Plane *bg_plane,Plane *fg_plane,void *dest)
{
  short x_fg=0,y_fg=0;
  short x_bg=0,y_bg=0;

  do
  {
    // Affichage
    DrawPlane(x_bg,y_bg,bg_plane,dest,TM_GRPLC,TM_G16B);
    DrawPlane(x_fg,y_fg,fg_plane,dest,TM_GTRANW,TM_G16B);

    FastCopyScreen_R(dest,GetPlane(LIGHT_PLANE));
    FastCopyScreen_R(dest+LCD_SIZE,GetPlane(DARK_PLANE));
/*
    memcpy(GetPlane(LIGHT_PLANE),dest,LCD_SIZE);
    memcpy(GetPlane(DARK_PLANE),dest+LCD_SIZE,LCD_SIZE);
*/

    BEGIN_KEYTEST
    // Déplacement
    if(_keytest_optimized(RR_UP) && y_bg>0)
      y_bg--,y_fg-=2;
    if(_keytest_optimized(RR_DOWN) && y_bg<12*16-128) // Note to self: 128 is on purpose !
      y_bg++,y_fg+=2;
    if(_keytest_optimized(RR_LEFT) && x_bg>0)
      x_bg--,x_fg-=2;
    if(_keytest_optimized(RR_RIGHT) && x_bg<20*16-WIDTH)
      x_bg++,x_fg+=2;
    END_KEYTEST

  } while(!_keytest(RR_ESC));
}

void _main(void)
{
  INT_HANDLER ai1,ai5;
  void *bloc=malloc(BIG_VSCREEN_SIZE*2*2+LCD_SIZE*2); // 2 big_vscreen et 1 buffer par plane
  void *vecran;
  Plane fg_plane,bg_plane;
  LCD_BUFFER backbuffer;

  LCD_save(backbuffer);

  if(!bloc)
    return;

// Initialisations
  vecran=bloc;

  bg_plane.matrix=bg_map;
  bg_plane.width=20;
  bg_plane.sprites=sprts;
  bg_plane.big_vscreen=bloc+LCD_SIZE*2;
  bg_plane.force_update=1;

  fg_plane.matrix=fg_map;
  fg_plane.width=25;
  fg_plane.sprites=sprts;
  fg_plane.big_vscreen=bloc+LCD_SIZE*2+BIG_VSCREEN_SIZE*2;
  fg_plane.force_update=1;

  ai1=GetIntVec(AUTO_INT_1);
  ai5=GetIntVec(AUTO_INT_5);
  SetIntVec(AUTO_INT_1,DUMMY_HANDLER);
  SetIntVec(AUTO_INT_5,DUMMY_HANDLER);

  if(GrayOn())
  {
    RenderMaps(&bg_plane,&fg_plane,vecran);
    GrayOff();
  }

  SetIntVec(AUTO_INT_1,ai1);
  SetIntVec(AUTO_INT_5,ai5);

  free(bloc);
  LCD_restore(backbuffer);
  GKeyFlush();
  ST_helpMsg(EXTGRAPH_VERSION_PWDSTR);
}
