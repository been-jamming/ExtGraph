#define NO_EXIT_SUPPORT
#define MIN_AMS 100
#define NO_AMS_CHECK

#ifdef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define C89_92V200(x,y) (x)
#else
#undef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define USE_TI92P
#define USE_V200
#define C89_92V200(x,y) (y)
#endif

#include <tigcclib.h>
#include "../../lib/ExtGraph.h"
#include "../../lib/TileMap.h"

#define NB_ETAPES 4
#define NB_ANIMS 21
#define MAP_WIDTH 32

unsigned char map_base[16][MAP_WIDTH]={ // Contient les n° d'animation
{00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00},
{00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,18,12,12,12,12,12,12,12,19,00,00,00,00,00},
{00,00,00,00,00,00,18,12,12,12,12,12,12,12,12,12,12,12,17,02,02,01,02,03,02,02,11,00,00,00,00,00},
{00,00,00,00,00,00,15,04,05,02,02,02,01,02,02,02,02,03, 8, 8, 8,02,02,04,05,02,11,00,00,00,00,00},
{00,00,00,00,00,00,15,06,07,02,02,02,02,02,02,01,02,02,02,02, 8,02,02,06,07,02,13,12,12,19,00,00},
{00,00,00,18,12,12,17,02,02,02,02,01,02,02,02,02,02,02,02,01, 8,02,02,02,02,02,02,02,01,13,19,00},
{00,00,00,15,02,01,02,02,02,01,02,02, 8, 8, 8,04,05,02, 8, 8, 8, 8,01,02,02,02,02,02,03,02,11,00},
{00,00,00,15,02,02,03,02, 8, 8, 8, 8, 8,03, 8,06,07,02, 8,02,03, 8, 8, 8,03,02,03,03,02,02,11,00},
{00,00,00,16,14,02,01, 8, 8,04,05,02,02,03, 8, 8, 8, 8, 8,02,02,02,03, 8, 8, 8, 8, 8, 8,02,11,00},
{00,00,00,00,15,02,02, 8,02,06,07,02,02,02,02,02,02,01, 8,02,04,05,02,02,02,02,02,01,02,02,11,00},
{00,00,00,00,15,01,02, 8,02,02,03,02,02,02,02,02,03, 8, 8,02,06,07,02,02,01,02,02,02,02,01,11,00},
{00,00,00,00,16,10,10,10,10,10,14,02,02,01,02,02,02, 8,02,02,02,02,02,02,02,02,02,02,02, 9,20,00},
{00,00,00,00,00,00,00,00,00,00,16,10,14,01,02,02,02, 8,02,02,01,02,02,01,02,02,03,01,02,11,00,00},
{00,00,00,00,00,00,00,00,00,00,00,00,16,10,10,10,10,10,10,10,10,10,10,14,02,02, 9,10,10,20,00,00},
{00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,16,10,10,20,00,00,00,00,00},
{00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00}
};

// Contient les n° de sprites de chaque anim pour chaque étape
short anim[NB_ETAPES][NB_ANIMS]={
{0,4,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26},
{1,5,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26},
{2,6,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26},
{3,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26}
};

short sprts[][32]={ // Contient les sprites (pris de xtile de Scott Noveck)
// 0 : Water
{0xFFFF,0x0000,0xCFCF,0x0000,0x8383,0x0000,0x3838,0x0000,0xFFFF,0x0000,0x1F1F,0x0000,0x4C4C,0x0000,0xE1E1,0x0000,0xFFFF,0x0000,0xCFCF,0x0000,0x8383,0x0000,0x3838,0x0000,0xFFFF,0x0000,0x1F1F,0x0000,0x4C4C,0x0000,0xE1E1,0x0000},	//Water1
{0xFFFF,0x0000,0xF3F3,0x0000,0xE0E0,0x0000,0x0E0E,0x0000,0xFFFF,0x0000,0x7C7C,0x0000,0x3131,0x0000,0x8787,0x0000,0xFFFF,0x0000,0xF3F3,0x0000,0xE0E0,0x0000,0x0E0E,0x0000,0xFFFF,0x0000,0x7C7C,0x0000,0x3131,0x0000,0x8787,0x0000},	//Water2
{0xFFFF,0x0000,0xFCFC,0x0000,0x3838,0x0000,0x8383,0x0000,0xFFFF,0x0000,0xF1F1,0x0000,0xC4C4,0x0000,0x1E1E,0x0000,0xFFFF,0x0000,0xFCFC,0x0000,0x3838,0x0000,0x8383,0x0000,0xFFFF,0x0000,0xF1F1,0x0000,0xC4C4,0x0000,0x1E1E,0x0000},	//Water3
{0xFFFF,0x0000,0x3F3F,0x0000,0x0E0E,0x0000,0xE0E0,0x0000,0xFFFF,0x0000,0xC7C7,0x0000,0x1313,0x0000,0x7878,0x0000,0xFFFF,0x0000,0x3F3F,0x0000,0x0E0E,0x0000,0xE0E0,0x0000,0xFFFF,0x0000,0xC7C7,0x0000,0x1313,0x0000,0x7878,0x0000},	//Water4

// 4 : Flower
{0x3800,0x0000,0x3810,0x0000,0xC654,0x0000,0xC628,0x0000,0xC600,0x0000,0x3800,0x0000,0x3800,0x0000,0x0000,0x0000,0x0000,0x0000,0x1038,0x0000,0x5438,0x0000,0x28C6,0x0000,0x00C6,0x0000,0x00C6,0x0000,0x0038,0x0000,0x0038,0x0000},	//Flower1
{0x0000,0x0000,0x3810,0x0000,0x4454,0x0000,0xC628,0x0000,0xC600,0x0000,0xBA00,0x0000,0x3800,0x0000,0x0000,0x0000,0x0000,0x0000,0x1038,0x0000,0x54BA,0x0000,0x28C6,0x0000,0x00C6,0x0000,0x0044,0x0000,0x0038,0x0000,0x0000,0x0000},	//Flower2
{0x0000,0x0000,0x3810,0x0000,0x3854,0x0000,0xC628,0x0000,0xC600,0x0000,0xC600,0x0000,0x3800,0x0000,0x3800,0x0000,0x0038,0x0000,0x1038,0x0000,0x54C6,0x0000,0x28C6,0x0000,0x00C6,0x0000,0x0038,0x0000,0x0038,0x0000,0x0000,0x0000},	//Flower4
{0x0000,0x0000,0x3810,0x0000,0xBA54,0x0000,0xC628,0x0000,0xC600,0x0000,0x4400,0x0000,0x3800,0x0000,0x0000,0x0000,0x0000,0x0000,0x1038,0x0000,0x5444,0x0000,0x28C6,0x0000,0x00C6,0x0000,0x00BA,0x0000,0x0038,0x0000,0x0000,0x0000},	//Flower3

// 8 : Grass
{0x0000,0x0000,0x1000,0x0000,0x5400,0x0000,0x2800,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0010,0x0000,0x0054,0x0000,0x0028,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},	//Grass2

// 9 : Plant
{0x0000,0x0000,0x0180,0x0180,0x63C6,0x6246,0x77EE,0x542A,0x7FFE,0x4DB2,0x6FF6,0x566A,0x77EE,0x4A52,0x3BDC,0x2664,0x1E78,0x1FF8,0x3BDC,0x27E4,0x774E,0x4AF2,0x7F7E,0x44A2,0x7FFE,0x7C3E,0x07E0,0x0420,0x03C0,0x03C0,0x0000,0x0000},	//Plant1

// 10 : Tree
{0x01FF,0x00FF,0x077F,0x0380,0x0DF8,0x0E00,0x17B0,0x1840,0x2F30,0x30C0,0x6E38,0x31C0,0x5C3F,0x63C0,0xDC1F,0x63E0,0x9C07,0xE3F8,0x9E00,0xE1FF,0x9F00,0xE0FF,0x9FC0,0xE03F,0x8FF0,0xF00F,0x8FF8,0xF007,0x83FF,0xFC00,0x80FF,0xFF00},	//Tree1
{0xFF80,0xFF00,0xE0E0,0x1FC0,0xF330,0x0CF0,0x79C8,0x0638,0x78E4,0x071C,0xF866,0x079C,0xF872,0x078E,0xF073,0x0F8E,0xE071,0x1F8F,0x00F1,0xFF0F,0x01F1,0xFE0F,0x07F1,0xF80F,0x0FF1,0xF00F,0x1FE1,0xE01F,0xFFC1,0x003F,0xFF01,0x00FF},	//Tree2
{0x803F,0xFFC0,0xC01F,0x7FE0,0xC007,0x7FF8,0xE000,0xBFFF,0xF000,0x9FFF,0xBC00,0xCFFF,0xE3E0,0x7FFF,0xFFD0,0x1C3F,0x79F8,0x080F,0x71FF,0x1007,0x33B8,0x2060,0x3778,0x20F0,0x3D94,0x23F8,0x3E0F,0x1FF8,0x0787,0x007C,0x003F,0x0003},	//Tree3
{0xFC01,0x03FF,0xF803,0x07FE,0xF003,0x0FFE,0x0007,0xFFFD,0x000F,0xFFF9,0x003D,0xFFF3,0x07C7,0xFFFE,0x0BFF,0xFC38,0x1F3E,0xF010,0xFF1E,0xE008,0xFD8C,0x0604,0xFECC,0x0F04,0xE9BC,0x1FC4,0xF07C,0x1FF8,0xE1C0,0x3E00,0xFC00,0xC000},	//Tree4

// 14 : Road
{0x7E7E,0x0000,0xFFFF,0x0000,0xF7F7,0x0000,0xFFFF,0x0000,0xBFBF,0x0000,0xFBFB,0x0000,0xFFFF,0x0000,0x7E7E,0x0000,0x7E7E,0x0000,0xFFFF,0x0000,0xF7F7,0x0000,0xFFFF,0x0000,0xBFBF,0x0000,0xFBFB,0x0000,0xFFFF,0x0000,0x7E7E,0x0000},	//Road1

// 15 : Edge
{0x0BFF,0x07FF,0x2C00,0x1FFF,0x57FF,0x3800,0x3804,0x6000,0xD040,0x6000,0x71FF,0xC000,0xA200,0xC1FF,0xA5FF,0xC3FF,0xA57F,0xC380,0xA5FF,0xC300,0xB5F8,0xC31F,0xA5CC,0xC33F,0xA5C6,0xC33F,0xA5C7,0xC33F,0xADC3,0xC33F,0xA5C3,0xC33F},	//Edge1
{0xFFFF,0xFFFF,0x0000,0xFFFF,0xFFFF,0x0000,0x0404,0x0000,0x4040,0x0000,0xFFFF,0x0000,0x0000,0xFFFF,0xFFFF,0xFFFF,0x1FF8,0xE007,0xF81F,0x07E0,0xE047,0x1FF8,0x0040,0xFFBF,0x2000,0xFFFF,0x0000,0xFFFF,0x07E0,0xFFFF,0xFFFF,0xFFFF},	//Edge2
{0xA5C3,0xC33F,0xA5C3,0xC33F,0xB583,0xC37F,0xA583,0xC37F,0xA583,0xC37F,0xA5C7,0xC33F,0xADC7,0xC33F,0xA5C7,0xC33F,0xA5C3,0xC33F,0xA5C3,0xC33F,0xB583,0xC37F,0xA583,0xC37F,0xA583,0xC37F,0xA5C7,0xC33F,0xADC7,0xC33F,0xA5C7,0xC33F},	//Edge3
{0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x0C0C,0xFFFF,0x0000,0xFFFF,0x4040,0xFFFF,0x0000,0xFFFF,0xC7C7,0x3838,0xFFFF,0x0000,0xFFFF,0xFFFF,0x0000,0xFFFF,0xFFFF,0x0000,0x0404,0x0000,0x4040,0x0000,0xFFFF,0x0000,0x0000,0xFFFF,0xFFFF,0xFFFF},	//Edge4
{0xA5C7,0xC33F,0xA5CF,0xC33F,0xB5DC,0xC33F,0xA5D0,0xC33F,0xA5C0,0xC33F,0xA5E0,0xC31F,0xAD7F,0xC380,0xA5BF,0xC3C0,0xA5FF,0xC3FF,0xA200,0xC1FF,0xB1FF,0xC000,0x9804,0xE000,0xCE40,0xF000,0x63FF,0xFC00,0xB000,0x7FFF,0x6FFF,0x1FFF},	//Edge5
// 20
{0xFFD0,0xFFE0,0x0034,0xFFF8,0xFFEA,0x001C,0x041C,0x0006,0x400B,0x0006,0xFF8E,0x0003,0x0045,0xFF83,0xFFA5,0xFFC3,0xFEA5,0x01C3,0xFFA5,0x00C3,0x1BB5,0xFCC3,0x33A5,0xFCC3,0x63A5,0xFCC3,0xE3A5,0xFCC3,0xC3AD,0xFCC3,0xC3A5,0xFCC3},	//Edge6
{0xC3A5,0xFCC3,0xC3A5,0xFCC3,0xC1B5,0xFEC3,0xC1A5,0xFEC3,0xC1A5,0xFEC3,0xE3A5,0xFCC3,0xE3AD,0xFCC3,0xE3A5,0xFCC3,0xC3A5,0xFCC3,0xC3A5,0xFCC3,0xC1B5,0xFEC3,0xC1A5,0xFEC3,0xC1A5,0xFEC3,0xE3A5,0xFCC3,0xE3AD,0xFCC3,0xE3A5,0xFCC3},	//Edge7
{0xC3A5,0xFCC3,0xC3A2,0xFCC1,0xC1B1,0xFEC0,0xC198,0xFEE0,0xC1CE,0xFEF0,0xE363,0xFCFC,0xE3B0,0xFC7F,0xE36F,0xFC1F,0xC1F8,0xFE07,0xC01F,0xFFE0,0xC047,0xFFF8,0xC040,0xFFBF,0xC000,0xFFFF,0xE000,0x7FFF,0x78E0,0x3FFF,0xBFFF,0x1FFF},	//Edge8
{0xE3A5,0xFCC3,0xF3A5,0xFCC3,0x3BB5,0xFCC3,0x0BA5,0xFCC3,0x03A5,0xFCC3,0x07A5,0xF8C3,0xFEAD,0x01C3,0xFDA5,0x03C3,0xFFA5,0xFFC3,0x0045,0xFF83,0xFF8D,0x0003,0x0419,0x0007,0x4073,0x000F,0xFFC6,0x003F,0x000D,0xFFFE,0xFFF6,0xFFF8},	//Edge9
{0x8FFF,0x1FFF,0x3FFF,0x3FFF,0x7C0C,0x7FFF,0x7000,0xFFFF,0xE040,0xFFFF,0xE300,0xFCFF,0xC7C7,0xF838,0xC7FF,0xF800,0xC37F,0xFCFF,0xC3E0,0xFCFF,0xC1CF,0xFEF0,0xC190,0xFEE0,0xC1A0,0xFEC0,0xE3A3,0xFCC0,0xE3A6,0xFCC1,0xE3A5,0xFCC3},	//Edge17
// 25
{0xFFF1,0xFFF8,0xFFFC,0xFFFC,0x0C3E,0xFFFE,0x000E,0xFFFF,0x4007,0xFFFF,0x00C7,0xFF3F,0xC7E3,0x381F,0xFFE3,0x001F,0xFEC3,0xFF3F,0x03C3,0xFF3F,0xF983,0x077F,0x0D83,0x037F,0x0583,0x037F,0xC5C7,0x033F,0x65C7,0x833F,0xA5C7,0xC33F},	//Edge19
{0xA5C3,0xC33F,0x45C3,0x833F,0x8D83,0x037F,0x1983,0x077F,0x7383,0x0F7F,0xC6C7,0x3F3F,0x0DC7,0xFE3F,0xF6C7,0xF83F,0x1F83,0xE07F,0xF803,0x07FF,0xE003,0x1FFF,0x0003,0xFFFF,0x2003,0xFFFF,0x0007,0xFFFE,0x071E,0xFFFC,0xFFFD,0xFFF8},	//Edge20
};

#define HEIGHT C89_92V200(100,128)
#define WIDTH  C89_92V200(160,240)

static inline void RenderMap(AnimatedPlane *plane,void *dest)
{
  short x=0,y=0;

  do
  {
    // Affichage
    DrawAnimatedPlane(x,y,plane,dest,TM_GRPLC,TM_GA16B);

    FastCopyScreen_R(dest,GetPlane(LIGHT_PLANE));
    FastCopyScreen_R(dest+LCD_SIZE,GetPlane(DARK_PLANE));
/*
    memcpy(GetPlane(LIGHT_PLANE),dest,LCD_SIZE);
    memcpy(GetPlane(DARK_PLANE),dest+LCD_SIZE,LCD_SIZE);
*/

    // Déplace la map
    BEGIN_KEYTEST
    if(_keytest_optimized(RR_UP) && y>0)
      y--;
    if(_keytest_optimized(RR_DOWN) && y<16*16-HEIGHT)
      y++;
    if(_keytest_optimized(RR_LEFT) && x>0)
      x--;
    if(_keytest_optimized(RR_RIGHT) && x<MAP_WIDTH*16-WIDTH)
      x++;
    END_KEYTEST

  } while(!_keytest(RR_ESC));
}

void _main(void)
{
  INT_HANDLER ai1,ai5;
  char *bloc=malloc(BIG_VSCREEN_SIZE*2+LCD_SIZE*2); // Un big_vscreen + un écran virtuel
  void *vecran;
  AnimatedPlane plane;
  LCD_BUFFER backbuffer;

  LCD_save(backbuffer);

  if(!bloc)
    return;

// Initialisations
  vecran=bloc;

// Initialisation du plane
  plane.p.matrix=map_base;
  plane.p.width=32;
  plane.p.sprites=sprts;
  plane.p.big_vscreen=bloc+LCD_SIZE*2;
  plane.p.force_update=1;
  plane.tabanim=anim;
  plane.nb_anim=NB_ANIMS;
  plane.nb_step=NB_ETAPES;
  plane.step=0;
  plane.step_length=18;
  plane.frame=0;

  ai1=GetIntVec(AUTO_INT_1);
  ai5=GetIntVec(AUTO_INT_5);

  SetIntVec(AUTO_INT_1,DUMMY_HANDLER);
  SetIntVec(AUTO_INT_5,DUMMY_HANDLER);

  if(GrayOn())
  {
    RenderMap(&plane,vecran);
    GrayOff();
  }

  SetIntVec(AUTO_INT_1,ai1);
  SetIntVec(AUTO_INT_5,ai5);

  free(bloc);
  LCD_restore(backbuffer);
  GKeyFlush();
  ST_helpMsg(EXTGRAPH_VERSION_PWDSTR);
}
