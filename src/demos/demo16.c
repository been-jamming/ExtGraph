#define NO_EXIT_SUPPORT
#define MIN_AMS 100
#define NO_AMS_CHECK

#ifdef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define C89_92V200(x,y) (x)
#else
#undef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define USE_TI92P
#define USE_V200
#define C89_92V200(x,y) (y)
#endif

#include <tigcclib.h>
#include "../../lib/extgraph.h"
#include "../../lib/tilemap.h"

static const char map[12][20]={ // Arrière-plan
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 6,11, 0, 0, 0},
{ 0, 0, 0, 1, 6, 6,11, 0, 0, 0, 0, 0, 1, 3, 8, 8,12,11, 0, 0},
{ 0, 0, 1, 3, 7,10,12,11, 0, 0, 0, 1, 3, 8, 7,10, 8,12,11, 0},
{ 0, 0, 2, 4, 8, 8,13,15, 0, 0, 0, 2, 4, 8, 8, 8, 8,13,14, 0},
{ 0, 0, 0, 5, 9, 9,14, 0, 0, 0, 0, 0, 5, 4, 8, 8,13,15, 0, 0},
{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 9, 9,14, 0, 0, 0},
{ 0, 0, 0, 1, 6,11, 0, 0, 1, 6, 6,11, 0, 0, 0, 0, 0, 0, 0, 0},
{ 0, 0, 0, 5, 9,14, 0, 1, 3, 8, 8,12,11, 0, 0, 0, 0, 0, 0, 0},
{ 6, 6,11, 0, 0, 0, 0, 5, 4, 8, 8,13,14, 0, 0, 0, 1, 6, 6,11},
{ 7,10,12,11, 0, 0, 0, 0, 2, 9, 9,15, 0, 0, 0, 0, 2, 9, 9,14},
{ 8, 8,13,14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}
};

static const short sprts[][32]={
// 0 : Nuage 1
{0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF,0x0000,0xFFFF},
// 1 : Nuage 2
{0x0007,0xFFF8,0x003F,0xFFC0,0x00F8,0xFF00,0x01C0,0xFE00,0x0300,0xFC00,0x0600,0xF800,0x0C00,0xF000,0x1800,0xE000,0x3000,0xC000,0x3000,0xC000,0x6000,0x8000,0x6000,0x8000,0x6000,0x8000,0xC000,0x0000,0xC000,0x0000,0xC000,0x0000},
// 2 : Nuage 3
{0xC000,0x0000,0xC000,0x0000,0xC000,0x0000,0x6000,0x8000,0x6000,0x8000,0x3800,0xC000,0x1F80,0xE000,0x07C0,0xF800,0x00C0,0xFF00,0x00C0,0xFF00,0x00C0,0xFF00,0x0060,0xFF80,0x0060,0xFF80,0x0038,0xFFC0,0x001F,0xFFE0,0x0007,0xFFF8},
// 3 : Nuage 4
{0xC000,0x0000,0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 4 : Nuage 5
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8000,0x0000,0xC000,0x0000},
// 5 : Nuage 6
{0xC000,0x0000,0xC000,0x0000,0xC000,0x0000,0x6000,0x8000,0x6000,0x8000,0x6000,0x8000,0x3000,0xC000,0x3000,0xC000,0x1800,0xE000,0x0C00,0xF000,0x0600,0xF800,0x0300,0xFC00,0x01C0,0xFE00,0x00F8,0xFF00,0x003F,0xFFC0,0x0007,0xFFF8},
// 6 : Nuage 7
{0xE007,0x1FF8,0xFC3F,0x03C0,0x1FF8,0x0000,0x03C0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 7 : Nuage 8
{0x0000,0x0000,0x0008,0x0000,0x001C,0x0000,0x001C,0x0000,0x001C,0x0000,0x001C,0x0000,0x001C,0x0000,0x0008,0x0000,0x0000,0x0000,0x0000,0x0000,0x0060,0x0000,0x00E0,0x0000,0x00F8,0x0000,0x007F,0x0000,0x001F,0x0000,0x0007,0x0000},
// 8 : Nuage 9 (tout blanc)
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 9 : Nuage 10
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x03C0,0x0000,0x1FF8,0x0000,0xFC3F,0x03C0,0xE007,0x1FF8},
// 10 : Nuage 11
{0x0000,0x0000,0x0800,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x1C00,0x0000,0x0800,0x0000,0x0000,0x0000,0x0000,0x0000,0x0600,0x0000,0x0700,0x0000,0x1F00,0x0000,0xFE00,0x0000,0xF800,0x0000,0xE000,0x0000},
// 11 : Nuage 12
{0xE000,0x1FFF,0xFC00,0x03FF,0x1F00,0x00FF,0x0380,0x007F,0x00C0,0x003F,0x0060,0x001F,0x0030,0x000F,0x0018,0x0007,0x000C,0x0003,0x000C,0x0003,0x0006,0x0001,0x0006,0x0001,0x0006,0x0001,0x0003,0x0000,0x0003,0x0000,0x0003,0x0000},
// 12 : Nuage 13
{0x0003,0x0000,0x0001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000},
// 13 : Nuage 14
{0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0003,0x0000},
// 14 : Nuage 15
{0x0003,0x0000,0x0003,0x0000,0x0003,0x0000,0x0006,0x0001,0x0006,0x0001,0x001C,0x0003,0x01F8,0x0007,0x03E0,0x001F,0x0300,0x00FF,0x0300,0x00FF,0x0300,0x00FF,0x0600,0x01FF,0x0600,0x01FF,0x1C00,0x03FF,0xF800,0x07FF,0xE000,0x1FFF},
// 15 : Nuage 16
{0x0003,0x0000,0x0003,0x0000,0x0003,0x0000,0x0006,0x0001,0x0006,0x0001,0x0006,0x0001,0x000C,0x0003,0x000C,0x0003,0x0018,0x0007,0x0030,0x000F,0x0060,0x001F,0x00C0,0x003F,0x0380,0x007F,0x1F00,0x00FF,0xFC00,0x03FF,0xE000,0x1FFF},
};

static char dh[128+16]={
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1,
0,0,0,0,1,2,3,4,5,5,5,5,4,3,2,1};

static short dv[128+16]={
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0,
0,BIG_VSCREEN_WIDTH/8,0,BIG_VSCREEN_WIDTH/8,0,0,0,0,0,-BIG_VSCREEN_WIDTH/8,0,-BIG_VSCREEN_WIDTH/8,0,0,0,0};

#define HEIGHT C89_92V200(100,128)
#define WIDTH  C89_92V200(160,240)

static inline void RenderMaps(void *big_vscreen,void *dest)
{
  short x=0,y=0,old_x=0,old_y=0,update=1;
  unsigned short i=0;

  do
  {
    // Affichage
    if(update)
    {
      RefreshGrayBuffer16B(20,&map[y>>4][x>>4],big_vscreen,sprts);
      update=0;
    }
#ifndef USE_TI89
    DrawGrayBufferWithShifts_RPLC(big_vscreen,x&15,y&15,dest,dh+((i>>3)&15),dv+((i>>3)&15));
#else
    DrawGrayBufferWithShifts89_RPLC(big_vscreen,x&15,y&15,dest,dh+((i>>3)&15),dv+((i>>3)&15));
#endif

    FastCopyScreen_R(dest,GrayGetPlane(LIGHT_PLANE));
    FastCopyScreen_R(dest+LCD_SIZE,GrayGetPlane(DARK_PLANE));
/*
    memcpy(GrayGetPlane(LIGHT_PLANE),dest,LCD_SIZE);
    memcpy(GrayGetPlane(DARK_PLANE),dest+LCD_SIZE,LCD_SIZE);
*/

    // Déplacement
    BEGIN_KEYTEST
    if(_keytest_optimized(RR_UP) && y>0)
      y--;
    if(_keytest_optimized(RR_DOWN) && y<12*16-HEIGHT-2)
      y++;
    if(_keytest_optimized(RR_LEFT) && x>0)
      x--;
    if(_keytest_optimized(RR_RIGHT) && x<19*16+11-WIDTH)
      x++;
    END_KEYTEST

    i++;

    update=(((x&16)^(old_x&16)) || ((y&16)^(old_y&16)));

    old_x=x;old_y=y;

  }while(!_keytest(RR_ESC));
}

void _main(void)
{
  INT_HANDLER ai1,ai5;
  void *bloc=malloc(BIG_VSCREEN_SIZE*2+LCD_SIZE*2); // 1 big_vscreen et 1 écran virtuel
  void *vecran,*big_vscreen;
  LCD_BUFFER backbuffer;

  LCD_save(backbuffer);

  if(!bloc)
    return;

// Initialisations
  vecran=bloc;

  big_vscreen=bloc+LCD_SIZE*2;

  ai1=GetIntVec(AUTO_INT_1);
  ai5=GetIntVec(AUTO_INT_5);
  SetIntVec(AUTO_INT_1,DUMMY_HANDLER);
  SetIntVec(AUTO_INT_5,DUMMY_HANDLER);

  if(GrayOn())
  {
    RenderMaps(big_vscreen,vecran);
    GrayOff();
  }

  SetIntVec(AUTO_INT_1,ai1);
  SetIntVec(AUTO_INT_5,ai5);

  free(bloc);
  LCD_restore(backbuffer);
  GKeyFlush();
  ST_helpMsg(EXTGRAPH_VERSION_PWDSTR);
}
