#define NO_EXIT_SUPPORT
#define MIN_AMS 100
#define NO_AMS_CHECK

#ifdef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define C89_92V200(x,y) (x)
#else
#undef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define USE_TI92P
#define USE_V200
#define C89_92V200(x,y) (y)
#endif

#include <tigcclib.h>
#include "../../lib/extgraph.h"
#include "../../lib/tilemap.h"

#define MAP_WIDTH 20
#define MAP_HEIGHT 12

static const char map[MAP_HEIGHT][MAP_WIDTH]={
{0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0},
{2,2,2,4,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0},
{0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0},
{0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0},
{0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0},
{2,2,2,3,2,2,2,2,2,2,3,2,2,5,0,0,0,0,0,0},
{0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0},
{0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0},
{2,2,2,5,0,0,0,0,2,2,3,2,2,2,2,2,2,2,2,2},
{0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0}};

static const short sprts[][16]={
// 0 : Prairie
{0b0000000000000000,
0b0000000000000000,
0b0000000000000000,
0b0000000000000000,
0b0000010000000000,
0b0000001001000000,
0b0000001010000000,
0b0000001010000000,
0b0000000000000000,
0b0000000000000000,
0b0000000000000000,
0b0000000000000000,
0b0000000000001000,
0b0000000010010000,
0b0000000001010000,
0b0000000000000000},
// 1 : Route Nord/Sud
{0b0011111001111100,
0b0011111001111100,
0b0011111001111100,
0b0011111111111100,
0b0011111111111100,
0b0011111001111100,
0b0011111001111100,
0b0011111001111100,
0b0011111001111100,
0b0011111001111100,
0b0011111001111100,
0b0011111111111100,
0b0011111111111100,
0b0011111001111100,
0b0011111001111100,
0b0011111001111100},
// 2 : Route Est/Ouest
{0b0000000000000000,
0b0000000000000000,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b0001100000011000,
0b0001100000011000,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b0000000000000000,
0b0000000000000000},
// 3 : Croisement
{0b0011111001111100,
0b0011111001111100,
0b1100000001111011,
0b1111111111111011,
0b1111111111111011,
0b1111111111111011,
0b1111111111111011,
0b0001111111111000,
0b0001111111111000,
0b1101111111111111,
0b1101111111111111,
0b1101111111111111,
0b1101111111111111,
0b1101111000000011,
0b0011111001111100,
0b0011111001111100},
// 4 : Virage Est/Sud
{0b0000000000000000,
0b0000000000000000,
0b1111111111111000,
0b1111111111111100,
0b1111111111111100,
0b1111111111111100,
0b1111111111111100,
0b0001100011111100,
0b0001100001111100,
0b1111111001111100,
0b1111111001111100,
0b1111111111111100,
0b1111111111111100,
0b1111111001111100,
0b0111111001111100,
0b0011111001111100},
// 5 : Virage Sud/Ouest
{0b0011111001111100,
0b0111111001111100,
0b1111111001111100,
0b1111111111111100,
0b1111111111111100,
0b1111111001111100,
0b1111111001111100,
0b0001100001111100,
0b0001100011111100,
0b1111111111111100,
0b1111111111111100,
0b1111111111111100,
0b1111111111111100,
0b1111111111111000,
0b0000000000000000,
0b0000000000000000}
};

void _main(void)
{
  short l,c,k;
  void *vecran;
  LCD_BUFFER backbuffer;

  LCD_save(backbuffer);

  if(!(vecran=malloc(LCD_SIZE)))
    return;

  l=c=0;

  do
  {
    DrawTiles16B(MAP_WIDTH,&map[l][c],vecran,sprts);

    FastCopyScreen_R(vecran,LCD_MEM);
/*
    memcpy(LCD_MEM,vecran,LCD_SIZE);
*/

    k=ngetchx();
    if(k==KEY_RIGHT && c<MAP_WIDTH-15)
      c++;
    if(k==KEY_LEFT && c>0)
      c--;
    if(k==KEY_DOWN && l<MAP_HEIGHT-8)
      l++;
    if(k==KEY_UP && l>0)
      l--;

  } while(k!=KEY_ESC);

  free(vecran);
  LCD_restore(backbuffer);
  GKeyFlush();
  ST_helpMsg(EXTGRAPH_VERSION_PWDSTR);
}
