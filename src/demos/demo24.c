#define NO_EXIT_SUPPORT
#define MIN_AMS 100
#define NO_AMS_CHECK

#ifdef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define C89_92V200(x,y) (x)
#else
#undef USE_TI89
#undef USE_TI92P
#undef USE_V200
#define USE_TI92P
#define USE_V200
#define C89_92V200(x,y) (y)
#endif

#include <tigcclib.h>
#include "../../lib/extgraph.h"
#include "../../lib/tilemap.h"

static const unsigned char map_bg[8+2*1][15+2*1]={ // Arrière-plan
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3},
{3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3}};

static const unsigned char map_m[8+2*2][15+2*2]={ // Plan du milieu
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0}};

static const unsigned char map_fg[8+2*3][15+2*3]={ // Plan de devant
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}};

static const unsigned short sprts[][16*2]={ // sprites 16x16 en niveaux de gris
// Sprites utilisés par le plan de devant :
{ // 0
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000,
0b0000000000000000,0b0000000000000000},
{ // 1
0b0000001111000000,0b0000001111000000,
0b0000111111110000,0b0000111111110000,
0b0001100000011000,0b0001100000011000,
0b0011000000001100,0b0011000000001100,
0b0110000110000110,0b0110000000000110,
0b0110001111000110,0b0110000000000110,
0b1100011111100011,0b1100000000000011,
0b1100111111110011,0b1100000000000011,
0b1100000000000011,0b1100111111110011,
0b1100000000000011,0b1100011111100011,
0b0110000000000110,0b0110001111000110,
0b0110000000000110,0b0110000110000110,
0b0011000000001100,0b0011000000001100,
0b0001100000011000,0b0001100000011000,
0b0000111111110000,0b0000111111110000,
0b0000001111000000,0b0000001111000000},

// sprite utilisé par le plan du milieu (le blanc est transparent) :
{ // 2
0b0111111111111110,0b0111111111111110,
0b1111111111111111,0b1000000000000001,
0b1111111111111111,0b1000000000000001,
0b1111111111111111,0b1000000000000001,
0b1111111111111111,0b1111111111111111,
0b1111111001111111,0b1111111001111111,
0b1111110000111111,0b1111110000111111,
0b1111100000011111,0b1111100000011111,
0b1111100000011111,0b1111100000011111,
0b1111110000111111,0b1111110000111111,
0b1111111001111111,0b1111111001111111,
0b1111111111111111,0b1111111111111111,
0b1000000000000001,0b1111111111111111,
0b1000000000000001,0b1111111111111111,
0b1000000000000001,0b1111111111111111,
0b0111111111111110,0b0111111111111110},

// Sprite utilisé par l'arrière-plan :
{ // 3
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b1111111100000000,0b0000000000000000,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111,
0b0000000011111111,0b1111111111111111}};


static const unsigned short sprtsm[][16]={ // sprites 16x16 noir et blanc (masques)
{ // 0
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111,
0b1111111111111111},
{ // 1
0b1111000000001111,
0b1110000000000111,
0b1100011111100011,
0b1000111111110001,
0b0001111001111000,
0b0001110000111000,
0b0011100000011100,
0b0011000000001100,
0b0011000000001100,
0b0011100000011100,
0b0001110000111000,
0b0001111001111000,
0b1000111111110001,
0b1100011111100011,
0b1110000000000111,
0b1111000000001111}};

static inline void RenderMaps(Plane *bg,Plane *mg,Plane *fgm,Plane *fg,void *dest)
{
  short x_bg=0,y_bg=0;
  short x_m=0,y_m=0;
  short x_fg=0,y_fg=0;

  do
  {
    // Affichage
    DrawPlane(x_bg,y_bg,bg,dest,TM_GRPLC,TM_G16B); // Arrière plan
    DrawPlane(x_m,y_m,mg,dest,TM_GTRANW,TM_G16B); // Plan du mileu
    DrawPlane(x_fg,y_fg,fgm,dest,TM_GMASK,TM_16B); // Masque du plan de devant
    DrawPlane(x_fg,y_fg,fg,dest,TM_GOR,TM_G16B); // Plan de devant

    FastCopyScreen_R(dest,GrayGetPlane(LIGHT_PLANE));
    FastCopyScreen_R(dest+LCD_SIZE,GrayGetPlane(DARK_PLANE));
/*
    memcpy(GrayGetPlane(LIGHT_PLANE),dest,LCD_SIZE);
    memcpy(GrayGetPlane(DARK_PLANE),dest+LCD_SIZE,LCD_SIZE);
*/

    // Déplacement
    BEGIN_KEYTEST
    if(_keytest_optimized(RR_UP) && y_bg>0)
      y_bg--,y_m-=2,y_fg-=3;
    if(_keytest_optimized(RR_DOWN) && y_bg<(8+2*1)*16-128)
      y_bg++,y_m+=2,y_fg+=3;
    if(_keytest_optimized(RR_LEFT) && x_bg>0)
      x_bg--,x_m-=2,x_fg-=3;
    if(_keytest_optimized(RR_RIGHT) && x_bg<(15+2*1)*16-240)
      x_bg++,x_m+=2,x_fg+=3;
    END_KEYTEST

  }while(!_keytest(RR_ESC));
}

void _main(void)
{
  INT_HANDLER ai1,ai5;
  void *bloc=malloc((unsigned long)GRAY_BIG_VSCREEN_SIZE*3+BIG_VSCREEN_SIZE+LCD_SIZE*2);
  Plane bg,mg,fg,fgm;
  void *vecran;
  LCD_BUFFER backbuffer;

  LCD_save(backbuffer);

  if(!bloc)
    return;

// Initialisations
  vecran=bloc; // Ecran virtuel

  bg.matrix=map_bg; // Arrière-plan
  bg.width=15+2*1;
  bg.sprites=sprts;
  bg.big_vscreen=bloc+LCD_SIZE*2;
  bg.force_update=1;

  mg.matrix=map_m; // Plan du milieu
  mg.width=15+2*2;
  mg.sprites=sprts;
  mg.big_vscreen=bloc+LCD_SIZE*2+GRAY_BIG_VSCREEN_SIZE;
  mg.force_update=1;

  fgm.matrix=map_fg; // Masque du plan de devant
  fgm.width=15+2*3;
  fgm.sprites=sprtsm;
  fgm.big_vscreen=bloc+LCD_SIZE*2+GRAY_BIG_VSCREEN_SIZE*2;
  fgm.force_update=1;

  fg.matrix=map_fg; // Plan de devant
  fg.width=15+2*3;
  fg.sprites=sprts;
  fg.big_vscreen=bloc+LCD_SIZE*2+GRAY_BIG_VSCREEN_SIZE*2+BIG_VSCREEN_SIZE;
  fg.force_update=1;

  ai1=GetIntVec(AUTO_INT_1);
  ai5=GetIntVec(AUTO_INT_5);
  SetIntVec(AUTO_INT_1,DUMMY_HANDLER);
  SetIntVec(AUTO_INT_5,DUMMY_HANDLER);

  if(GrayOn())
  {
    RenderMaps(&bg,&mg,&fgm,&fg,vecran);
    GrayOff();
  }

  SetIntVec(AUTO_INT_1,ai1);
  SetIntVec(AUTO_INT_5,ai5);

  free(bloc);
  LCD_restore(backbuffer);
  GKeyFlush();
  ST_helpMsg(EXTGRAPH_VERSION_PWDSTR);
}
